---
layout: post
title: "Gradle/JMockit/Code Coverage Troubles"
date: 2014-03-01 16:37:01 +0100
comments: true
categories: [Gradle, JaCoCo, code coverage, jmockit, testing]
---
For the past week, I've been ~~playing~~ messing around with generating a decent test coverage report through Gradle. The project I am currently working on contains many older unit tests which use jMock. However, most of the newer ones use JMockit. JMockit seems to be a little tricky to integrate with most of the popular code coverage tools out there. Here are my experiences for using jMock and JMockit with EMMA, Cobertura, and JaCoCo.

# EMMA
I always liked EMMA. Sure, it is pretty old and not actively developed any more, but it still does its job. The generated reports look nice, it is fast, and the Jenkins plugin also generates decent graphs. The [EMMA Plugin](https://github.com/breskeby/gradleplugins/tree/master/emmaPlugin) for Gradle enables easy integration with Gradle. I've never had any issues when using it in combination with jMock. However, EMMA doesn't seem to get along well with JMockit. I've been getting `ClassFormatErrors` left and right when using `@BeforeClass` and `@AfterClass` in my unit tests. Mocking methods in static classes via `new MockUp<T>` also didn't work properly. Others have experienced the same issues (see [1](https://code.google.com/p/jmockit/issues/detail?id=239), [2](http://stackoverflow.com/questions/905052/classformaterror-using-jmockit-with-emma)) . After trying out multiple versions of EMMA and JMockit, I gave up. Needless to say, when skipping the `emma` task in Gradle, all tests pass.

# Cobertura
I've also never had any issues with Cobertura and jMock. The [Cobertura plugin](https://github.com/stevesaliman/gradle-cobertura-plugin) for Gradle is easy to set up and I think the generated reports are by far the nicest (in terms of readability). I especially like those generated by the Jenkins plugin. However, using Cobertura with JMockit also poses some issues: While it was not throwing any exceptions, several tests just kept hanging and never finished. Until today, I haven't figured out why.

# JaCoCo
JaCoCo was developed as a replacement for EMMA - however, I am not sure if JaCoCo is based on the EMMA code. Gradle allows to generate code coverage reports through its built-in [Jacoco plugin](http://www.gradle.org/docs/current/userguide/jacoco_plugin.html). The [Jacoco plugin](https://wiki.jenkins-ci.org/display/JENKINS/JaCoCo+Plugin) for Jenkins offers an easy way to integrate a test coverage report in Jenkins. I don't like the reports too much as I think that they are a little bit difficult to read - especially when trying to figure out which package needs more attention. Everything works smooth with jMock, but guess what? For the my given unit tests, it didn't play well with JMockit either. Unlike EMMA, no JVM errors are thrown, but some tests kept hanging forever. Luckily, there is a fairly simple workaround (also suggested [here](https://groups.google.com/forum/#!topic/jmockit-users/X9RpdAu45Ek)):

Instead of including JMockit throught the classpath (e.g., through `testCompile 'com.googlecode.jmockit:jmockit:1.5'`), it seems to work when being included through the `-javaagent` JVM flag:

```
test {
  jvmArgs "-javaagent:${project.rootDir.absolutePath}/path/to/jmockit.jar"
}
```
In order to be able to run the tests through Eclipse, I added the `jmockit.jar` to the classpath in the `eclipse` task. As I don't generate code coverage in Eclipse (i.e., JaCoCo is only ran through Gradle), this doesn't pose any issues.

# JMockit coverage
The easiest solution seems to use the [JMockit Coverage](http://jmockit.googlecode.com/svn/trunk/www/tutorial/CodeCoverage.html) library. Just throw JMockit and JMockit Coverage into your classpath and everything works fine:
```
testCompile 'com.googlecode.jmockit:jmockit:1.5'
testCompile 'com.googlecode.jmockit:jmockit-coverage:0.999.24'
```
That's it - All tests pass, not a single issue! It will automatically generate a report in the base directory from where the tests are ran (per default this is where your `build.gradle` sits). The configuration is pretty straight forward and fairly flexible. Unfortunatly, there are two things I really disliked about JMockit Coverage:

* The reports look very cluttered and are difficult to read
* There is no Jenkins plugin ([it seems like](https://groups.google.com/forum/#!topic/jmockit-users/LFAODclLNDs)  I am not the only one who would like to see one)

# Final thoughts
If you can live without a Jenkins plugin, use JMockit plus its own coverage tool. As having no Jenkins integration is a deal breaker for me, I'm going to stick with the JaCoCo workaround for now. It may also be worth investigating the effects of online/offline instrumentation, but well, one thing at a time.
